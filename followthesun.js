//dimensioni finestra
var wW = window.innerWidth;
var wH = window.innerHeight;

//parametro distanza
var distanza=100; 

//scena
scene = new THREE.Scene();
	
//telecamere
camUp = new THREE.OrthographicCamera(wW / - distanza*3, wW / distanza*3, wH/ distanza*3, wH / - distanza*3, 1, 1000 );
scene.add(camUp);
camUp.position.set(-distanza*4,0,-distanza/2);
camUp.rotation.y=-Math.PI/2;
	
var camSide = new THREE.OrthographicCamera(wW / - distanza*3, wW / distanza*3, wH/ distanza*3, wH / - distanza*3, 1, 1000 );
scene.add(camSide);
camSide.position.set(0,distanza*4,-distanza/2);
camSide.rotation.x=-Math.PI/2;
camSide.rotation.z=-Math.PI/2;
	
var camFront = new THREE.OrthographicCamera(wW / - distanza/1.5, wW / distanza/1.5, wH/ distanza/1.5, wH / - distanza/1.5, 1, 1000 );
scene.add(camFront);
camFront.position.set(0,0,-distanza*4);
camFront.rotation.y=-Math.PI;

camera = new THREE.PerspectiveCamera( 3, window.innerWidth/window.innerHeight, 0.10, distanza*1.03 );
camera.rotation.y=Math.PI;

//helper telecamera
var helper = new THREE.CameraHelper( camera );
scene.add( helper );
helper.visible=true;

//dummy camera
var dummy_camera = new THREE.Object3D();
dummy_camera.add(camera);
scene.add(dummy_camera);

//assi
var axesHelper = new THREE.AxesHelper( 5 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               scene.add( axesHelper );

//renderizzatore
renderer = new THREE.WebGLRenderer({antialias:true }); //,alpha: true
renderer.setSize( window.innerWidth, window.innerHeight );
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.BasicShadowMap;
document.body.appendChild( renderer.domElement );
		
//sole
var text_sole = new THREE.TextureLoader().load( "suntex.jpg" );
var geom_sole = new THREE.SphereGeometry(2,64,64);
var mat_sole = new THREE.MeshBasicMaterial( { map: text_sole, side: THREE.DoubleSide } );
var sole=new THREE.Mesh(geom_sole,mat_sole);
scene.add(sole)
	
//terra
var text_terra = new THREE.TextureLoader().load( "world_map.png" );
var geom_terra = new THREE.SphereGeometry(1,64,64);	
var mat_terra = new THREE.MeshBasicMaterial( { map: text_terra, side: THREE.DoubleSide } );
var  terra= new THREE.Mesh(geom_terra,mat_terra) 

//asse_rot
var geom_asse = new THREE.CylinderGeometry( 0.03, 0.03, 3, 8);
var mat_asse = new THREE.MeshBasicMaterial( {color: 0xff0000} );
var asse = new THREE.Mesh( geom_asse, mat_asse);

//dummy posizione telecamera
var geom_dummy = new THREE.BoxGeometry(0.1,0.5,0.1);
var col_dummy = new THREE.Color (0,0,1);
var mat_dummy= new THREE.MeshBasicMaterial( {color : col_dummy});
var dummy= new THREE.Mesh(geom_dummy,mat_dummy);
dummy.position.set(0,0.66,0.66);
dummy.rotation.x=Math.PI/4;
	
//oggetto terra	
var ogg_terra = new THREE.Object3D();
ogg_terra.add(terra);
ogg_terra.add(dummy);
ogg_terra.add(asse);

//asse_terra
var ass_terra = new THREE.Object3D();
ass_terra.add(ogg_terra);
scene.add(ass_terra);
ass_terra.position.set(0,0,-distanza);

//colori background	
var background1 = new THREE.Color( 0.1, 0.1, 0.1 );
var background2 = new THREE.Color( 0.5, 0.5, 0.7 );

//GUI
var gui = new dat.GUI();

//var cam = gui.addFolder('Camera');
var obj = {
	lat:  45,
	tilt: 0
};
gui.add(obj, "lat", -90, 90).listen();
gui.add(obj, "tilt", -23.45, 23.45).listen();
//cam.open();

var animate = function () {
	requestAnimationFrame(animate);
	//var aggiornamento=dummy.getWorldPosition(scene);
	//----------------------------------------------------------------------
	//rotazione della telecamera
	ogg_terra.rotation.y += 2*Math.PI/1440;
	var d = dummy.getWorldPosition();
	dummy_camera.position.x=d.x;
	dummy_camera.position.y=d.y;
	dummy_camera.position.z=d.z;
	var h_primo = Math.sqrt(d.y*d.y+d.x*d.x);
	var angolox=Math.atan(d.z/d.y);
	var angoloz=Math.atan(d.x/d.y);
	var angoloy=Math.atan(d.z/d.x);
	var bo = Math.atan(h_primo/d.z);
	//var angolox=Math.atan(d.x/d.z);
	//camera.rotation.y=-Math.PI/2;
	
	var rad_ang=Math.PI/2-obj.lat/180*Math.PI;
	dummy.rotation.x=rad_ang;
	dummy.position.set(0,Math.cos(rad_ang),Math.sin(rad_ang));
	var asse_rot=obj.tilt/180*Math.PI;
	ass_terra.rotation.z=asse_rot;
	
	camera.rotation.x=-bo;
	dummy_camera.rotation.z=-angoloz;
	//dummy_camera.rotation.z=-angoloz; //-Math.PI/2	

	
	//camera.updateProjectionMatrix();
	//camera.rotation.x=-angolo;
	//vector.setFromMatrixPosition( dummy.matrixWorld );	
	//document.getElementById('h').innerHTML = bo;//360*angoloz/(2*Math.PI);
	//camera.rotation.y=-ogg_terra.rotation.y
	//var diffx=dummypos.x-ogg_terra.position.x;
	//var diffy=dummypos.y-ogg_terra.position.y;
	//var diffz=dummypos.z-ogg_terra.position.z;
	//var rotz=Math.atan(diffx/diffy);
	//var roty=Math.atan(diffx/diffz);
	//var rotx=Math.atan(diffy/diffz);

	//camera.rotation.set(rotx,roty,rotz);
	//camera.lookAt(0,0,0);
	
	//camera.lookAt(0,0,0);
	//------------------------------------------------------------------
		
	var left = Math.floor( wW * 0 );
	var bottom = Math.floor( wH * 0.5 );
	var width = Math.floor( wW * 0.5 );
	var height = Math.floor( wH * 0.5 );
	renderer.setViewport( left,bottom,width,height );
	renderer.setScissor( left,bottom,width,height  );
	renderer.setScissorTest( true );		
	camUp.updateProjectionMatrix();
	camUp.aspect=wW/wH;
	renderer.setClearColor( background1 );
	renderer.render( scene, camUp );	
	
	var left = Math.floor( wW * 0 );
	var bottom = Math.floor( wH * 0 );
	var width = Math.floor( wW * 0.5 );
	var height = Math.floor( wH * 0.5 );
	renderer.setViewport( left,bottom,width,height );
	renderer.setScissor( left,bottom,width,height  );
	renderer.setScissorTest( true );		
	camSide.updateProjectionMatrix();
	camSide.aspect=wW/wH;
	renderer.setClearColor( background1 );
	renderer.render( scene, camSide );	
	
	var left = Math.floor( wW * 0.5 );
	var bottom = Math.floor( wH * 0 );
	var width = Math.floor( wW * 0.5 );
	var height = Math.floor( wH * 0.5 );
	renderer.setViewport( left,bottom,width,height );	
	renderer.setScissor( left,bottom,width,height  );
	renderer.setScissorTest( true );		
	camFront.updateProjectionMatrix();
	camFront.aspect=wW/wH;
	renderer.setClearColor( background1 );
	renderer.render( scene, camFront );	
	
	dummy.visible=false;
	var left = Math.floor( wW * 0.5 );
	var bottom = Math.floor( wH * 0.5 );
	var width = Math.floor( wW * 0.5 );
	var height = Math.floor( wH * .5 );
	renderer.setViewport( left,bottom,width,height );
	renderer.setScissor( left,bottom,width,height  );
	renderer.setScissorTest( true );
	camera.updateProjectionMatrix();
	camera.aspect=wW/wH;
	renderer.setClearColor( background2 );
	renderer.render( scene, camera );		
	dummy.visible=true;
	//-------------------------------------------------------------------------
	//renderer.render( scene, camera );
	helper.update();
	//requestAnimationFrame( animate );
	};

animate();
